package com.board.controller;

import java.io.File;
import java.net.URLEncoder;
import java.util.*;

import org.apache.commons.io.FileUtils;
import org.springframework.data.domain.Page;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.board.dto.BoardDTO;
import com.board.dto.FileDTO;
import com.board.dto.MemberDTO;
import com.board.dto.ReplyDTO;
import com.board.dto.ReplyInterface;
import com.board.entity.BoardEntity;
import com.board.entity.LikeEntity;
import com.board.entity.MemberEntity;
import com.board.entity.repository.BoardRepository;
import com.board.entity.repository.MemberRepository;
import com.board.service.BoardService;
import com.board.service.MemberService;
import com.board.util.PageUtil;

import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import lombok.RequiredArgsConstructor;
import lombok.ToString;

@CrossOrigin(originPatterns = "http://localhost:3000")
@RestController
@RequiredArgsConstructor
public class RESTController {
	
	private final BoardRepository boardRepository;
	private final MemberRepository memberRepository;
	private final MemberService mservice;
	private final BoardService bservice;
	private final BCryptPasswordEncoder pwdEncoder;
	
	
	
	
	//게시물 등록(화면 보기)
	@GetMapping("/restapi/write")
	public void getWrite() {}
	
	//게시물 내용 상세 보기 
		@GetMapping("/restapi/view")
		public BoardDTO getView(@RequestParam("seqno") Long seqno,@RequestParam("email") String email) throws Exception {
			return bservice.view(seqno); 
		}

	
	//전체게시물 목록 가져오기
	@GetMapping("/restapi/listAll")
	public List<BoardDTO> getList() throws Exception {
		List<BoardDTO> boardDTOs = new ArrayList<>();
		boardRepository.findAll().stream().forEach(list -> boardDTOs.add(new BoardDTO(list)));
		return boardDTOs;
		}
	
	//게시물 목록 보기
	@GetMapping("/restapi/list")
		public Page<BoardEntity> getList(@RequestParam("page") int pageNum,
				@RequestParam(name="keyword",defaultValue="",required=false) String keyword) throws Exception{
			//model.addAttribute("list",mapper.list());
			int postNum = 5; //한 화면에 보여지는 게시물 행의 갯수
			int pageListCount = 10; //화면 하단에 보여지는 페이지리스트 내의 페이지 갯수
			
			return bservice.list(pageNum, postNum, keyword);
		}
	//게시물 이전 보기
	@GetMapping("/restapi/preseqno")
	public String getPreseqno(@RequestParam("seqno") Long seqno,
	@RequestParam(name="keyword",required=false) String keyword) throws Exception {		
		return "{\"pre_seqno\":\"" + bservice.pre_seqno(seqno, keyword) + "\"}";		
	}
	
	//게시물 다음 보기
	@GetMapping("/restapi/nextseqno")
	public String getNextseqno(@RequestParam("seqno") Long seqno, 
	@RequestParam(name="keyword",required=false) String keyword) throws Exception {		
		return "{\"next_seqno\":\"" + bservice.next_seqno(seqno, keyword) + "\"}"; 		
	}

	//게시물 목록 페이지 리스트 보기
		@GetMapping("/restapi/pagelist")
		public String getPageList(@RequestParam("page") int pageNum, @RequestParam(name="keyword",defaultValue="",required=false) String keyword) throws Exception {
			int postNum = 5; //한 화면에 보여지는 게시물 행의 갯수
			int pageListCount = 5; //화면 하단에 보여지는 페이지리스트 내의 페이지 갯수
			
			Page<BoardEntity> list = getList(pageNum, keyword);
			
			PageUtil page = new PageUtil();
			return "{\"pagelist\":\"" + page.getPageList(pageNum, postNum, pageListCount, (int)list.getTotalElements(), keyword) + "\"}";
		}
	
		//파일 목록 보기
		@GetMapping("/restapi/fileView")
		public List<FileDTO> getFileView(@RequestParam("seqno") Long seqno) throws Exception {
			List<FileDTO> fileDTOs = new ArrayList<>();
			bservice.fileListView(seqno).stream().forEach(file -> fileDTOs.add(new FileDTO(file)));
			return fileDTOs;
		}
		

		//파일 다운로드
		@GetMapping("/restapi/filedownload")
		public void filedownload(@RequestParam("fileseqno") Long fileseqno, HttpServletResponse rs) throws Exception {
			
			String path = "c:\\Repository\\file\\";
			
			FileDTO fileInfo = bservice.fileInfo(fileseqno);
			
			byte fileByte[] = FileUtils.readFileToByteArray(new File(path+fileInfo.getStored_filename()));
			
			//헤드값을 Content-Disposition로 주게 되면 Response Body로 오는 값을 filename으로 다운받으라는 것임
			//예) Content-Disposition: attachment; filename="hello.jpg"
			rs.setContentType("application/octet-stream");
			rs.setContentLength(fileByte.length);
			rs.setHeader("Content-Disposition",  "attachment; filename=\""+URLEncoder.encode(fileInfo.getOrg_filename(), "UTF-8")+"\";");
			rs.getOutputStream().write(fileByte);
			rs.getOutputStream().flush();//버퍼에 있는 내용을 write
			rs.getOutputStream().close();
			
		}
	//좋아요/싫어요 상태 보기
		@GetMapping("/restapi/likeCheckView")
		public String getLikeCheckView(@RequestParam("seqno") Long seqno, @RequestParam("email") String email) throws Exception {
			
			LikeEntity likeCheckView = bservice.likeCheckView(seqno, email);
			String result = "";
			
			//초기에 좋아요/싫어요 등록이 안되어져 있을 경우 "N"으로 초기화		
			if(likeCheckView == null) { 
				result = "{\"myLikeCheck\":\"N\",\"myDislikeCheck\":\"N\"}";
			} else if(likeCheckView != null) 
				result = "{\"myLikeCheck\":\"" + likeCheckView.getMylikecheck()
				+ "\",\"myDislikeCheck\":\"" + likeCheckView.getMydislikecheck() + "\"}";
			System.out.println("좋아요/싫어요 상태 = " + result);
			return result;	
		}
	//댓글 처리
		@PostMapping("/restapi/reply")
		public List<ReplyInterface> postReply(ReplyInterface reply,@RequestParam("option") String option)throws Exception{
			
			switch(option) {
			
			case "I" : bservice.replyRegistry(reply); //댓글 등록
					   break;
			case "U" : bservice.replyUpdate(reply); //댓글 수정
					   break;
			case "D" : bservice.replyDelete(reply); //댓글 삭제
					   break;
			}

			return bservice.replyView(reply);
		}

	
	//로그인 처리
	@PostMapping("/restapi/loginCheck")
	public String postLogIn(MemberDTO loginData,HttpSession session,@RequestParam("autoLogin") String autoLogin) throws Exception{
		
		String authkey = "";
		
		//로그인 시 자동로그인으로 체크할 경우 신규 authkey 등록
		if(autoLogin.equals("NEW")){
			authkey = UUID.randomUUID().toString().replaceAll("-", "");
			loginData.setAuthkey(authkey);
			mservice.authkeyUpdate(loginData);
		}
		//authkey가 클라이언트에 쿠키로 존재할 경우 로그인 과정 없이 게시판 목록 페이지로 이동
		if(autoLogin.equals("PASS")) {
			if(memberRepository.findByAuthkey(loginData.getAuthkey()) != null) {
				return "{\"message\":\"good\"}";
			}else {
				return "{\"message\":\"bad\"}";
			}
		}
		
		//아이디 존재 여부 확인
		if(mservice.idCheck(loginData.getEmail()) == 0)
			return "{\"message\":\"ID_NOT_FOUND\"}";
		
		//아이디가 존재하면 읽어온 email로 로그인 정보 가져 오기
		MemberDTO member = mservice.memberInfo(loginData.getEmail());
		
		//패스워드 확인
		if(!pwdEncoder.matches(loginData.getPassword(),member.getPassword())) 
			return "{\"message\":\"PASSWORD_NOT_FOUND\"}";
		String str = "{\"message\":\"good\",\"authkey\":\"" + member.getAuthkey() + "\",\"username\":\""
				+ URLEncoder.encode(member.getUsername(),"UTF-8") + "\",\"role\":\"" + member.getRole() + "\" }";
		System.out.println("str="+ str);
		return str;

		
		}
	
	@GetMapping("/restapi/visit")
	public String getRandomVisit() {

		//숫자 + 영문대소문자 10자리 임시패스워드 생성
		StringBuffer tempPW = new StringBuffer();
		Random rnd = new Random();
		for (int i = 0; i < 10; i++) {
		    int rIndex = rnd.nextInt(3);
		    switch (rIndex) {
		    case 0:
		        // a-z : 아스키코드 97~122
		    	tempPW.append((char) ((int) (rnd.nextInt(26)) + 97));
		        break;
		    case 1:
		        // A-Z : 아스키코드 65~122
		    	tempPW.append((char) ((int) (rnd.nextInt(26)) + 65));
		        break;
		    case 2:
		        // 0-9
		    	tempPW.append((rnd.nextInt(10)));
		        break;
		    }
		}
		
		
		return "{\"rvalue\":\"" + tempPW.toString()+ "\"}";
	}
	
}
